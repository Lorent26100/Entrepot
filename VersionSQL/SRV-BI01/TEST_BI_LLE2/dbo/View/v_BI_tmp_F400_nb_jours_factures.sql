/****** Object:  View [dbo].[v_BI_tmp_F400_nb_jours_factures]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE VIEW [dbo].[BI_tmp_F400_nb_jours_factures] AS
SELECT
BI_tmp_F400_nb_jours_factures_1.F400KY, 
BI_tmp_F400_nb_jours_factures_1.Nb_jours, 
BI_tmp_F400_nb_jours_factures_1.F400DTDEPFAC, 
BI_tmp_F400_nb_jours_factures_1.F400DTARRFAC
FROM
 (
  SELECT
  BI_tmp_mvts_nb_jours_F570KY_2.F400KY AS F400KY, SUM(CAST(DATEDIFF(MI, BI_tmp_mvts_nb_jours_F570KY_2.F400DTDEPFAC_cal , BI_tmp_mvts_nb_jours_F570KY_2.F400DTARRFAC_cal ) AS decimal) / ((dbo.HeureFin() - dbo.HeureDebut())*60)) AS Nb_jours, MIN(BI_tmp_mvts_nb_jours_F570KY_2.F400DTDEPFAC) AS F400DTDEPFAC, MIN(BI_tmp_mvts_nb_jours_F570KY_2.F400DTARRFAC) AS F400DTARRFAC
  FROM
   (
    SELECT
    F400EVT.F400KY AS F400KY, CASE WHEN (F400EVT.F400DTDEPFAC_date  < Dim_Calendar.date_enreg) THEN DATEADD(MI,  dbo.HeureDebut() * 60, CAST(Dim_Calendar.date_enreg  as datetime)) WHEN ((DATEPART(HH, F400EVT.F400DTDEPFAC)  * 100 + DATEPART(MI, F400EVT.F400DTDEPFAC)) < dbo.HeureDebutInteger()) THEN DATEADD(MI,  dbo.HeureDebut() * 60, CAST(F400EVT.F400DTDEPFAC_date as datetime)) WHEN ((DATEPART(HH, F400EVT.F400DTDEPFAC)  * 100 + DATEPART(MI, F400EVT.F400DTDEPFAC)) > dbo.HeureFinInteger()) THEN DATEADD(MI, dbo.HeureFin() * 60, CAST(F400EVT.F400DTDEPFAC_date as datetime)) ELSE F400EVT.F400DTDEPFAC END AS F400DTDEPFAC_cal, CASE WHEN (F400EVT.F400DTARRFAC_date  > Dim_Calendar.date_enreg) THEN DATEADD(MI, dbo.HeureFin() * 60, CAST(Dim_Calendar.date_enreg as datetime)) WHEN ((DATEPART(HH, F400EVT.F400DTARRFAC)  * 100 + DATEPART(MI, F400EVT.F400DTARRFAC)) > dbo.HeureFinInteger()) THEN DATEADD(MI, dbo.HeureFin() * 60, CAST(F400EVT.F400DTARRFAC_date AS datetime)) WHEN ((DATEPART(HH, F400EVT.F400DTARRFAC)  * 100 + DATEPART(MI, F400EVT.F400DTARRFAC)) < dbo.HeureDebutInteger()) THEN DATEADD(MI, dbo.HeureDebut() * 60, CAST(F400EVT.F400DTARRFAC_date AS datetime)) ELSE F400EVT.F400DTARRFAC END AS F400DTARRFAC_cal, F400EVT.F400DTDEPFAC AS F400DTDEPFAC, F400EVT.F400DTARRFAC AS F400DTARRFAC
    FROM
     (
      SELECT
      F400_F410_1.F400KY AS F400KY, F400_F410_1.F400DTDEPFAC AS F400DTDEPFAC, CAST(F400_F410_1.F400DTDEPFAC as date) AS F400DTDEPFAC_date, F400_F410_1.F400DTARRFAC AS F400DTARRFAC, CAST(F400_F410_1.F400DTARRFAC as date) AS F400DTARRFAC_date
      FROM
       (
        SELECT
        F400EVT.F400KY AS F400KY, CASE WHEN (F400EVT.K400T63STATU = '3') THEN MIN(COALESCE(F400EVT.F400DTDEPFAC, F410LIG.F410DTDEPFAC)) END AS F400DTDEPFAC, CASE WHEN (F400EVT.K400T63STATU = '3') THEN MAX(COALESCE(F400EVT.F400DTARRFAC, F410LIG.F410DTARRFAC)) END AS F400DTARRFAC
        FROM
         F400EVT INNER JOIN  F410LIG ON(  F410LIG.K410400EVT = F400EVT.F400KY )
        GROUP BY F400EVT.F400KY, F400EVT.K400T63STATU 
        
       ) F400_F410_1
     ) F400EVT INNER JOIN  (
      SELECT
      BI_Dim_Calendar.date_enreg AS date_enreg
      FROM
       BI_Dim_Calendar
     ) Dim_Calendar ON(  Dim_Calendar.date_enreg >= F400EVT.F400DTDEPFAC_date  AND Dim_Calendar.date_enreg <= F400EVT.F400DTARRFAC_date   )
   ) BI_tmp_mvts_nb_jours_F570KY_2
  GROUP BY BI_tmp_mvts_nb_jours_F570KY_2.F400KY
  
 ) BI_tmp_F400_nb_jours_factures_1
