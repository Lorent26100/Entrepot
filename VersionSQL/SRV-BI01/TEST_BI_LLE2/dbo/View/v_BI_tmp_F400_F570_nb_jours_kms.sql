/****** Object:  View [dbo].[v_BI_tmp_F400_F570_nb_jours_kms]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE VIEW BI_tmp_F400_F570_nb_jours_kms AS
SELECT
BI_tmp_F400_F570_nb_jours_kms_1.F400KY, 
BI_tmp_F400_F570_nb_jours_kms_1.Nb_jours_factures, 
BI_tmp_F400_F570_nb_jours_kms_1.Nb_jours_loues, 
BI_tmp_F400_F570_nb_jours_kms_1.Nb_kms, 
BI_tmp_F400_F570_nb_jours_kms_1.Nb_vehicules, 
BI_tmp_F400_F570_nb_jours_kms_1.is_470
FROM
 (
  SELECT
  BI_tmp_F400_F570_nb_jours_kms_0.F400KY AS F400KY, MIN(BI_tmp_F400_F570_nb_jours_kms_0.is_470 ) AS is_470, MIN(BI_tmp_F400_F570_nb_jours_kms_0.Nb_jours_factures ) * MIN(BI_tmp_F400_F570_nb_jours_kms_0.signe ) AS Nb_jours_factures, SUM(BI_tmp_F400_F570_nb_jours_kms_0.Nb_jours_loues  * BI_tmp_F400_F570_nb_jours_kms_0.signe ) AS Nb_jours_loues, SUM(BI_tmp_F400_F570_nb_jours_kms_0.Nb_kms ) AS Nb_kms, COUNT(DISTINCT BI_tmp_F400_F570_nb_jours_kms_0.K570090UNI) AS Nb_vehicules
  FROM
   (
    SELECT
    F400EVT_is_470.F400KY AS F400KY, F400EVT_is_470.is_470 AS is_470, F400EVT_is_470.signe AS signe, F400EVT_is_470.Nb_jours_factures_cal AS Nb_jours_factures, CASE /*LD et mvt total*/ WHEN (F400EVT_is_470.is_470 = 1 AND F570MVT.F570DTDEP < F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR > F400EVT_is_470.F400DTARRFAC) THEN F400EVT_is_470.nb_jours_factures /* non-LD ou (LD et mvt sur période facturation) */	WHEN (F400EVT_is_470.is_470 = 0 OR (F400EVT_is_470.is_470 = 1 AND F570MVT.F570DTDEP >= F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR <= F400EVT_is_470.F400DTARRFAC)) THEN BI_tmp_mvts_nb_jours_F570KY.Nb_jours  END AS Nb_jours_loues, CASE /*LD et mvt total*/ WHEN (F400EVT_is_470.is_470 = 1 AND F570MVT.F570DTDEP < F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR > F400EVT_is_470.F400DTARRFAC) THEN BI_tmp_mvts_nb_jours_F570KY.Nb_kms / BI_tmp_mvts_nb_jours_F570KY.Nb_jours * F400EVT_is_470.nb_jours_factures /* non-LD ou (LD et mvt inclus dans période facturation) */	WHEN (F400EVT_is_470.is_470 = 0 OR (F400EVT_is_470.is_470 = 1 AND (F570MVT.F570DTDEP >= F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR <= F400EVT_is_470.F400DTARRFAC))) THEN BI_tmp_mvts_nb_jours_F570KY.Nb_kms/* LD et mvt avec fin dans période facturation */	WHEN (F400EVT_is_470.is_470 = 1 AND F570MVT.F570DTDEP <= F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR between F400EVT_is_470.F400DTDEPFAC AND F400EVT_is_470.F400DTARRFAC) THEN BI_tmp_mvts_nb_jours_F570KY.Nb_kms / BI_tmp_mvts_nb_jours_F570KY.Nb_jours * DATEDIFF(day, F400EVT_is_470.F400DTDEPFAC, F570MVT.F570DTARR)/* LD et mvt avec début dans période facturation */	WHEN (F400EVT_is_470.is_470 = 1 AND F570MVT.F570DTDEP between F400EVT_is_470.F400DTDEPFAC AND F400EVT_is_470.F400DTARRFAC AND F570MVT.F570DTARR >= F400EVT_is_470.F400DTARRFAC) THEN BI_tmp_mvts_nb_jours_F570KY.Nb_kms / BI_tmp_mvts_nb_jours_F570KY.Nb_jours * DATEDIFF(day, F570MVT.F570DTDEP, F400EVT_is_470.F400DTARRFAC) END AS Nb_kms, CASE /*LD et mvt total*/ WHEN (F400EVT_is_470.is_470 = 1 AND F570MVT.F570DTDEP < F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR > F400EVT_is_470.F400DTARRFAC) THEN F570MVT.K570090UNI  /* non-LD ou (LD et mvt sur période facturation) */	WHEN (F400EVT_is_470.is_470 = 0 OR (F400EVT_is_470.is_470 = 1 AND ((F570MVT.F570DTDEP >= F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR <= F400EVT_is_470.F400DTARRFAC) OR (F570MVT.F570DTDEP <= F400EVT_is_470.F400DTDEPFAC AND F570MVT.F570DTARR between F400EVT_is_470.F400DTDEPFAC AND F400EVT_is_470.F400DTARRFAC) OR (F570MVT.F570DTDEP between F400EVT_is_470.F400DTDEPFAC AND F400EVT_is_470.F400DTARRFAC AND F570MVT.F570DTARR >= F400EVT_is_470.F400DTARRFAC)))) THEN F570MVT.K570090UNI   END AS K570090UNI
    FROM
     (
      SELECT
      F400EVT.F400KY AS F400KY, F400EVT.R400570MVT AS R400570MVT, BI_tmp_F400_nb_jours_factures.F400DTDEPFAC AS F400DTDEPFAC, BI_tmp_F400_nb_jours_factures.F400DTARRFAC AS F400DTARRFAC, CASE WHEN (F470_DISTINCT_R470400EVTTIE.R470400EVTTIE  IS NOT NULL) THEN 1 ELSE 0 END AS is_470, DATEDIFF(d, F400EVT.F400DTDEPFAC, F400EVT.F400DTARRFAC) + 1 AS Nb_jours_factures, BI_tmp_F400_nb_jours_factures.Nb_jours AS Nb_jours_factures_cal, CASE WHEN F400EVT.F400HT  < 0 THEN -1 ELSE 1 END AS signe
      FROM
       F400EVT LEFT OUTER JOIN  (
        SELECT
        DISTINCT F470LD.R470400EVTTIE  AS R470400EVTTIE
        FROM
         F470LD
       ) F470_DISTINCT_R470400EVTTIE ON(  F470_DISTINCT_R470400EVTTIE.R470400EVTTIE = F400EVT.R400EVT )
       LEFT OUTER JOIN  BI_tmp_F400_nb_jours_factures ON(  BI_tmp_F400_nb_jours_factures.F400KY = F400EVT.F400KY )
     ) F400EVT_is_470 LEFT OUTER JOIN  F570MVT ON(  F570MVT.R570MVT = F400EVT_is_470.R400570MVT )
     LEFT OUTER JOIN  BI_tmp_mvts_nb_jours_F570KY ON(  BI_tmp_mvts_nb_jours_F570KY.F570KY = F570MVT.F570KY )
   ) BI_tmp_F400_F570_nb_jours_kms_0
  GROUP BY BI_tmp_F400_F570_nb_jours_kms_0.F400KY 
  
 ) BI_tmp_F400_F570_nb_jours_kms_1
