/****** Object:  View [dbo].[v_BI_Dim_Clients]    Committed by VersionSQL https://www.versionsql.com ******/

CREATE     VIEW [dbo].[v_BI_Dim_Clients] AS SELECT
ROW_NUMBER() OVER(ORDER BY F050TIERS.F050KY DESC) AS BI_Dim_Clients_dKey,
F050TIERS.F050KY AS Code, 
F050TIERS.F050NOM AS Nom, 
F050TIERS.F050PRENOM AS Prenom, 
Adresses_Pays.F020CP AS Code_postal, 
Adresses_Pays.F020VILLE AS Ville, 
Adresses_Pays.K020T53CTY AS Code_pays,
Adresses_Pays.F901MSG AS Libelle_pays, 
Adresses_Pays.Localisation AS Localisation, 
VT15TIT.FT15KY AS Code_titre, 
VT15TIT.F901MSG AS Libelle_titre, 
F050TIERS.F050IATA AS IATA, 
F050TIERS.F050APE AS Code_APE, 
F050TIERS.F050CDP AS Code_remise_CDP, 
F050TIERS.F050STATIS AS Regroup_statistiques, 
F050TIERS.F050SIREN AS SIREN, 
F050TIERS.K050050COM AS Code_commercial, 
dbo.concatenation(Liens_commerciaux_17.F050NOM,Liens_commerciaux_17.F050PRENOM,' ') AS Nom_commercial, 
F057CPTA_typ_1.K057306ANA AS Analytique, 
F050TIERS.K050030AGE AS Agence, 
VTE8FAMILLE.FTE8KY AS Code_famille_comptable, 
VTE8FAMILLE.F901MSG AS Libelle_famille_comptable, 
F05WLIE_GROUPE.K05W050PERE AS Code_groupe, 
F05WLIE_GROUPE.F050NOM AS Nom_groupe, 
F051_first_RIB.F051DOMIC AS RIB_Domiciliation, 
F051_first_RIB.F051IBAN AS RIB_IBAN, 
F057CPTA_typ_1.K057320RGL AS Mode_de_reglement, 
F057CPTA_typ_1.F057ECH AS Echeance, 
Adresses_Pays.F020SIRET AS SIRET, 
F050TIERS.K050110TAR AS Code_tarif, 
CASE WHEN (F050TIERS.F050ACTIF  = '2') THEN 0 ELSE 1 END AS Actif, 
Adresses_Pays.F020ADRES1 AS Adresse1, 
Adresses_Pays.F020ADRES2 AS Adresse2, 
Adresses_Pays.F020ADRES3 AS Adresse3, 
Adresses_Pays.F020ADRES4 AS Adresse4
FROM
 F050TIERS INNER JOIN  (
  SELECT
  DISTINCT F05ZTYPE.K05Z050TIE  AS K05Z050TIE, F05ZTYPE.K05ZT05TYP AS K05ZT05TYP
  FROM
   F05ZTYPE
  WHERE
  F05ZTYPE.K05ZT05TYP = '1'
 ) Liens_types_tiers_1 ON(  Liens_types_tiers_1.K05Z050TIE = F050TIERS.F050KY )
 INNER JOIN  VT15TIT ON(  VT15TIT.FT15KY = F050TIERS.K050T15TIT )
 LEFT OUTER JOIN  VTE8FAMILLE ON(  VTE8FAMILLE.FTE8KY = F050TIERS.K050TE8FAMCPTA )
 LEFT OUTER JOIN  (
  SELECT
  F020ADR.F020KY AS F020KY, F020ADR.F020CP AS F020CP, F020ADR.F020VILLE AS F020VILLE, F020ADR.K020T53CTY AS K020T53CTY, VT53CTY.F901MSG AS F901MSG, CASE WHEN F020ADR.K020T53CTY  != 'FR' THEN F020ADR.K020T53CTY  WHEN SUBSTRING(F020ADR.F020CP , 1, 2) = '97' THEN SUBSTRING(F020ADR.F020CP , 1, 3) ELSE SUBSTRING(F020ADR.F020CP , 1, 2) END AS Localisation, F020ADR.F020SIRET AS F020SIRET, F020ADR.F020ADRES1 AS F020ADRES1, F020ADR.F020ADRES2 AS F020ADRES2, F020ADR.F020ADRES3 AS F020ADRES3, F020ADR.F020ADRES4 AS F020ADRES4
  FROM
   F020ADR INNER JOIN  VT53CTY ON(  VT53CTY.FT53KY = F020ADR.K020T53CTY )
 ) Adresses_Pays ON(  Adresses_Pays.F020KY = F050TIERS.K050020ADR )
 LEFT OUTER JOIN  (
  SELECT
  F050TIERS.F050KY AS F050KY, F050TIERS.F050NOM AS F050NOM, F050TIERS.F050PRENOM AS F050PRENOM
  FROM
   F05ZTYPE INNER JOIN  F050TIERS ON(  F050TIERS.F050KY = F05ZTYPE.K05Z050TIE )
  WHERE
  F05ZTYPE.K05ZT05TYP = '17'
 ) Liens_commerciaux_17 ON(  Liens_commerciaux_17.F050KY = F050TIERS.K050050COM )
 LEFT OUTER JOIN  (
  SELECT
  F057CPTA.K057050KY AS K057050KY, F057CPTA.K057306ANA AS K057306ANA, F057CPTA.K057320RGL AS K057320RGL, F057CPTA.F057ECH AS F057ECH
  FROM
   F057CPTA
  WHERE
  F057CPTA.K057T05TYP = '1'
  AND  F057CPTA.F057ORDRE = 0
 ) F057CPTA_typ_1 ON(  F057CPTA_typ_1.K057050KY = F050TIERS.F050KY )
 LEFT OUTER JOIN  (
  SELECT
  DISTINCT F05WLIE.K05W050PERE  AS K05W050PERE, F05WLIE.K05W050FILS AS K05W050FILS, F050TIERS.F050NOM AS F050NOM
  FROM
   F05WLIE INNER JOIN  F05ZTYPE ON(  F05ZTYPE.K05Z050TIE = F05WLIE.K05W050PERE )
   INNER JOIN  F050TIERS ON(  F050TIERS.F050KY = F05ZTYPE.K05Z050TIE )
  WHERE
  F05WLIE.K05WT21LIE = 'GROUPE'
  AND  F05ZTYPE.K05ZT05TYP = 'GROUPE'
 ) F05WLIE_GROUPE ON(  F05WLIE_GROUPE.K05W050FILS = F050TIERS.F050KY )
 LEFT OUTER JOIN  (
  SELECT
  F051RIB.K051050TIE AS K051050TIE, F051RIB.F051DOMIC AS F051DOMIC, F051RIB.F051IBAN AS F051IBAN
  FROM
   F051RIB INNER JOIN  (
    SELECT
    F051RIB.K051050TIE AS K051050TIE, MIN(F051RIB.F051ORDRE) AS MIN_F051ORDRE
    FROM
     F051RIB
    GROUP BY F051RIB.K051050TIE 
    
   ) F051RIB_MIN_ORDRE ON(  F051RIB_MIN_ORDRE.K051050TIE = F051RIB.K051050TIE AND  F051RIB_MIN_ORDRE.MIN_F051ORDRE = F051RIB.F051ORDRE )
 ) F051_first_RIB ON(  F051_first_RIB.K051050TIE = F050TIERS.F050KY )
